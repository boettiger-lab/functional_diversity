---
title: "BBS Analysis"
output: html_document
---


```{r, echo=FALSE}

library(tidyverse)
library(dplyr)
library(FD)
library(spData)
library(sf)
library(tmap)
library(furrr)

piggyback::pb_download(repo = "karinorman/functional_diversity")

load("./data/trait.rda")
load("./data/bbs.rda")


min_year = 2006 #define the minimum year of sampling to include

p <- st_crs(wkt='PROJCS["USA_Contiguous_Albers_Equal_Area_Conic",
    GEOGCS["GCS_North_American_1983",
            DATUM["North_American_Datum_1983",
            SPHEROID["GRS_1980",6378137,298.257222101]],
            PRIMEM["Greenwich",0],
            UNIT["Degree",0.017453292519943295]],
            PROJECTION["Albers_Conic_Equal_Area"],
            PARAMETER["False_Easting",0],
            PARAMETER["False_Northing",0],
            PARAMETER["longitude_of_center",-96],
            PARAMETER["Standard_Parallel_1",29.5],
            PARAMETER["Standard_Parallel_2",45.5],
            PARAMETER["latitude_of_center",37.5],
            UNIT["Meter",1],
            AUTHORITY["EPSG","102003"]]')

```
We want to be able to figure out if a site's Functional Diversity (FD) is significantly different than what we would expect for a site with that richness level in that region. First we must simulate a null model of the relationship between FD and species diversity for a given region.

Code below attempts to create a null model curve (n = 1) for the Northern Rockies.
```{r}
#site level FD with region assignments
bbs_site_FD <- get_complete_site_data()


###Simulate null model for one region###

#get sites in the Northern rockies region and get species pool for that region
n_rockies_FD <- filter(bbs_site_FD, region == "NORTHERN ROCKIES")
n_rockies <- bbs %>% 
  filter(year > min_year & site_id %in% unique(n_rockies_FD$site_id)) %>%
  left_join(., select(n_rockies_FD, site_id, geometry), by = "site_id") #get the geometry column for mapping

species_pool <- unique(n_rockies$scientific)

#function to calculate FD from a list of species
get_sample_fd <- function(x, richness, ...){
  samp_trait_mat <- get_trait_matrix(sample(species_pool, richness))
  sample_FD <- dbFD(x = samp_trait_mat, ...)
  return(head(sample_FD, -1)) #remove last element, which is the CWM for each trait
}

#get sample summary statistics for each richness level observed in a region 
simulate_null <- function(region_data, n = 1000){
  richness_levels <- unique(region_data$nbsp)
  
  #Get n FD samples for a given richness value
  null_samples <- function(richness){
    test <- map_dfr(1:n, possibly(get_sample_fd, data.frame()), richness = richness) %>%
      select(-nbsp, -sing.sp) %>%
      gather(factor_key = TRUE) %>%
      group_by(key) %>%
      summarise(mean = mean(value), sd = sd(value)) %>%
      mutate(se = sd/sqrt(n),
             lowerCI = mean - qt(0.975, n - 1) * se, 
             upperCI = mean + qt(0.975, n - 1) * se) %>%
      # gather(variable, value, -key) %>%
      # unite(temp, key, variable) %>%
      # spread(temp, value) %>%
      mutate(richness = richness) %>%
      rename(metric = key) %>%
      select(richness, everything())
  }
  
  test_sim <- future_map_dfr(richness_levels[1:10], null_samples)
    
}

plan(multicore)
system.time({n_rockies_null <- simulate_null(n_rockies_FD, n = 10)})

metric_names <- c("FRic", "qual.FRic", "FEve", "FDiv", "FDis", "RaoQ")

#check if given metric is significant for that site
check_metric_sig <- function(name){
    metric_data <- filter(n_rockies_null, richness == site_data$nbsp, metric == name)
    if (site_data[[name]] < metric_data$upperCI & site_data[[name]] > metric_data$lowerCI){
      return(TRUE)
    }else{ return(FALSE)}
  }  

#check if any metrics are significant for a given site
check_site_sig <- function(site_data){
  map_dfc(metric_names, check_metric_sig) %>%
    set_colnames(metric_names)
}

#check significanc of all metrics at all sites
sig_df <- apply(n_rockies_FD, 1, check_site_sig) %>% bind_rows()


#preliminary plot of null curve
FDdf %>% ggplot(aes(x = nbsp, y = FDiv)) + geom_smooth() +
  theme_classic()

```

Map of the example ecoregion
```{r}
n_rockies_sites <- n_rockies %>%
  select(site_id, geometry) %>%
  unique() %>%
  st_as_sf()

bcr <- functional.diversity::get_ecoreg_shp() %>%
  mutate(in_region = as.factor(case_when(BCRNAME == "NORTHERN ROCKIES" ~ 1,
                               TRUE ~ 0)))

ma = tm_shape(bcr) + tm_polygons(col = "in_region", palette = "Greys") +
  tm_shape(n_rockies_sites) + tm_symbols(size = 0.1 , col = "red")
ma 
```

